apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgresql-cluster
  namespace: databases
spec:
  enablePDB: false
  instances: 3
  primaryUpdateStrategy: supervised
  enableSuperuserAccess: true
  superuserSecret:
    name: postgres-secrets
  storage:
    size: 1Gi
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "1"
      memory: "2Gi"
  bootstrap:
    initdb:
      database: initial_db
      owner: initial_user
      postInitSQL:
        - CREATE USER terraform WITH PASSWORD '$(TERRAFORM_DB_PASSWORD)';
        - CREATE DATABASE terraform WITH OWNER terraform;
        - GRANT ALL PRIVILEGES ON DATABASE terraform TO terraform;
        - GRANT ALL ON SCHEMA public TO terraform;
        - CREATE USER zitadel WITH PASSWORD '$(ZITADEL_DB_PASSWORD)';
        - CREATE DATABASE zitadel WITH OWNER zitadel;
        - GRANT ALL PRIVILEGES ON DATABASE zitadel TO zitadel;
  env:
    - name: TERRAFORM_DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: postgres-secrets
          key: terraform_pg_password
    - name: ZITADEL_DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: postgres-secrets
          key: zitadel_pg_password
