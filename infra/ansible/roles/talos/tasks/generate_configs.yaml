---
# Generate Talos configurations using the generate-configs.sh script

- name: Check if talosconfig already exists
  ansible.builtin.stat:
    path: "{{ talos_config_file }}"
  register: existing_talosconfig

- name: Backup existing talosconfig if it exists
  ansible.builtin.copy:
    src: "{{ talos_config_file }}"
    dest: "{{ talos_config_file }}.backup-{{ ansible_date_time.epoch }}"
    mode: '0600'
    remote_src: yes
  when: existing_talosconfig.stat.exists
  register: talosconfig_backup

- name: Display backup location
  ansible.builtin.debug:
    msg: "Existing talosconfig backed up to: {{ talosconfig_backup.dest }}"
  when: existing_talosconfig.stat.exists

- name: Run generate-configs.sh script
  ansible.builtin.command:
    cmd: "{{ talos_dir }}/generate-configs.sh"
    chdir: "{{ talos_dir }}"
  register: generate_result
  changed_when: true
  environment:
    SOPS_AGE_KEY_FILE: "{{ age_config_dir }}/age.key"

- name: Display generation output
  ansible.builtin.debug:
    var: generate_result.stdout_lines
  when: enable_detailed_output

- name: Decrypt generated talosconfig
  ansible.builtin.command:
    cmd: >
      sops --config {{ repo_root }}/.sops.yaml
      --output {{ talos_dir }}/talosconfig.yaml
      -d {{ talos_dir }}/config.enc.yaml
  environment:
    SOPS_AGE_KEY_FILE: "{{ age_config_dir }}/age.key"
  no_log: true
  changed_when: true

- name: Ensure .talos directory exists
  ansible.builtin.file:
    path: "{{ talos_config_file | dirname }}"
    state: directory
    mode: '0700'

- name: Check if talosconfig in destination already exists
  ansible.builtin.stat:
    path: "{{ talos_config_file }}"
  register: dest_talosconfig_stat

- name: Backup destination talosconfig if it exists
  ansible.builtin.copy:
    src: "{{ talos_config_file }}"
    dest: "{{ talos_config_file | dirname }}/config.backup-{{ ansible_date_time.epoch }}"
    mode: '0600'
    remote_src: yes
  when: dest_talosconfig_stat.stat.exists
  register: dest_talosconfig_backup

- name: Display destination backup location
  ansible.builtin.debug:
    msg: "Destination talosconfig backed up to: {{ dest_talosconfig_backup.dest }}"
  when: dest_talosconfig_stat.stat.exists

- name: Copy talosconfig to destination
  ansible.builtin.copy:
    src: "{{ talos_dir }}/talosconfig.yaml"
    dest: "{{ talos_config_file }}"
    mode: '0600'
    remote_src: yes

- name: Remove decrypted talosconfig from talos directory
  ansible.builtin.file:
    path: "{{ talos_dir }}/talosconfig.yaml"
    state: absent

- name: Verify talosconfig is in place
  ansible.builtin.stat:
    path: "{{ talos_config_file }}"
  register: final_talosconfig
  failed_when: not final_talosconfig.stat.exists

- name: Display success message
  ansible.builtin.debug:
    msg:
      - "✓ Talos configurations generated successfully"
      - "✓ Talosconfig deployed to {{ talos_config_file }}"
      - "✓ All node configs encrypted and ready in {{ talos_dir }}/"
