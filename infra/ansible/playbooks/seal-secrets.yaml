---
- name: Seal 1Password secrets for Kubernetes
  hosts: kubernetes
  gather_facts: no

  pre_tasks:
    - name: Verify required tools are installed
      ansible.builtin.command:
        cmd: "which {{ item }}"
      loop:
        - kubectl
        - kubeseal
        - op
      changed_when: false

    - name: Display seal-secrets information
      ansible.builtin.debug:
        msg:
          - "============================================================================"
          - "Seal 1Password Secrets"
          - "============================================================================"
          - ""
          - "This playbook will:"
          - "  1. Retrieve 1Password token from 1Password"
          - "  2. Retrieve 1Password credentials file from 1Password"
          - "  3. Create Kubernetes secret manifests"
          - "  4. Seal secrets using kubeseal"
          - "  5. Write sealed secrets to: {{ k8s_infra_dir }}/security/one-password/"
          - ""
          - "Requirements:"
          - "  - 1Password CLI authenticated (op signin)"
          - "  - Sealed Secrets controller running in cluster"
          - "  - Secrets exist in 1Password:"
          - "    • Token: {{ op_token_id }}"
          - "    • Credentials: {{ op_credential_file_id }}"
          - ""
          - "⚠️  Manual Steps Required After:"
          - "  1. Review sealed secrets in {{ k8s_infra_dir }}/security/one-password/"
          - "  2. git add {{ k8s_infra_dir }}/security/one-password/*.yaml"
          - "  3. git commit -m 'Update 1Password sealed secrets'"
          - "  4. git push"
          - ""
          - "============================================================================"

  roles:
    - role: one_password
      tags: [seal-secrets, onepassword]

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg:
          - "============================================================================"
          - "✅ Sealed Secrets Created"
          - "============================================================================"
          - ""
          - "Files created:"
          - "  • {{ k8s_infra_dir }}/security/one-password/onepassword-token.yaml"
          - "  • {{ k8s_infra_dir }}/security/one-password/op-credentials.yaml"
          - ""
          - "Next steps:"
          - "  1. Review the sealed secrets"
          - "  2. Commit to Git:"
          - ""
          - "     git add {{ k8s_infra_dir }}/security/one-password/*.yaml"
          - "     git commit -m 'Update 1Password sealed secrets'"
          - "     git push"
          - ""
          - "  3. ArgoCD will automatically sync and apply the secrets"
          - ""
          - "============================================================================"
