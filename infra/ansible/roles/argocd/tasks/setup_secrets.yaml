---
# Setup ArgoCD secrets from 1Password

- name: Check if 1Password CLI is signed in
  ansible.builtin.command:
    cmd: op whoami
  register: op_signin_check
  changed_when: false
  failed_when: false

- name: Ensure 1Password CLI is signed in
  ansible.builtin.fail:
    msg: |
      1Password CLI is not signed in. Please sign in first:
        eval $(op signin)
      Or set OP_SERVICE_ACCOUNT_TOKEN environment variable for service accounts.
  when: op_signin_check.rc != 0

- name: Retrieve ArgoCD Redis secret from 1Password
  ansible.builtin.command:
    cmd: "op read op://{{ op_argocd_redis_id }}"
  register: argocd_redis_secret
  changed_when: false
  no_log: true

- name: Write Redis secret to temporary file
  ansible.builtin.copy:
    content: "{{ argocd_redis_secret.stdout }}"
    dest: /tmp/argocd_redis.txt
    mode: '0600'
  no_log: true

- name: Create argocd namespace
  ansible.builtin.command:
    cmd: "kubectl --kubeconfig={{ kubeconfig }} create namespace {{ argocd_namespace }}"
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: create_namespace
  failed_when: false
  changed_when: create_namespace.rc == 0

- name: Create Kubernetes secret for argocd-redis
  ansible.builtin.command:
    cmd: >
      kubectl -n {{ argocd_namespace }}
      create secret generic argocd-redis
      --dry-run=client
      --from-file=auth=/tmp/argocd_redis.txt
      -o yaml
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: redis_secret_yaml
  changed_when: false

- name: Apply argocd-redis secret
  ansible.builtin.command:
    cmd: "kubectl apply -f -"
    stdin: "{{ redis_secret_yaml.stdout }}"
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: redis_secret_apply
  changed_when: "'configured' in redis_secret_apply.stdout or 'created' in redis_secret_apply.stdout"

- name: Remove temporary secret file
  ansible.builtin.file:
    path: /tmp/argocd_redis.txt
    state: absent
