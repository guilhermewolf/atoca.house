---
controllers:
  openclaw:
    replicas: 1
    annotations:
      reloader.stakater.com/auto: "true"
    initContainers:
      install-tools:
        image:
          repository: ghcr.io/openclaw/openclaw
          tag: 2026.2.21@sha256:ce271192cd70250d16fc5911903d9953467a40faf8b34e87cbd042e6b49b6036
        command:
          - /bin/sh
          - -c
          - |
            set -e
            mkdir -p /home/node/.local/bin /home/node/.local/go

            echo "Starting tool installation..."

            # Install gh CLI if not present on PVC
            if [ ! -f /home/node/.local/bin/gh ]; then
              echo "Installing gh CLI..."
              cd /tmp
              curl -fsSL https://github.com/cli/cli/releases/download/v2.61.0/gh_2.61.0_linux_amd64.tar.gz -o gh.tar.gz
              tar xzf gh.tar.gz
              cp gh_2.61.0_linux_amd64/bin/gh /home/node/.local/bin/
              rm -rf gh.tar.gz gh_2.61.0_linux_amd64
            fi

            # Install Go if not present on PVC
            if [ ! -f /home/node/.local/go/bin/go ]; then
              echo "Installing Go..."
              cd /tmp
              curl -fsSL https://go.dev/dl/go1.23.5.linux-amd64.tar.gz -o go.tar.gz
              tar xzf go.tar.gz
              mv go /home/node/.local/
              rm -rf go.tar.gz
            fi

            # Install Homebrew if not present on PVC
            if [ ! -f /home/node/.local/homebrew/bin/brew ]; then
              echo "Installing Homebrew..."
              export HOMEBREW_PREFIX=/home/node/.local/homebrew
              export HOMEBREW_CELLAR=/home/node/.local/homebrew/Cellar
              export HOMEBREW_REPOSITORY=/home/node/.local/homebrew
              mkdir -p $HOMEBREW_PREFIX
              cd /tmp
              git clone --depth 1 https://github.com/Homebrew/brew $HOMEBREW_PREFIX
            fi

            # Check if pip is available (either standalone or via python3 -m pip)
            set +e # Don't fail on pip errors
            if command -v pip3 >/dev/null 2>&1 || command -v pip >/dev/null 2>&1 || python3 -m pip --version >/dev/null 2>&1; then
              echo "pip is available"
            else
              echo "Installing pip..."
              cd /tmp
              curl -fsSL https://bootstrap.pypa.io/get-pip.py -o get-pip.py
              python3 get-pip.py --user --no-warn-script-location --break-system-packages || \
              python3 get-pip.py --user --no-warn-script-location || \
              echo "pip install skipped (use python3 -m pip instead)"
              rm -f get-pip.py
            fi
            set -e # Re-enable error checking

            echo "Tool installation complete"

            # Ensure config directory exists
            mkdir -p /home/node/.openclaw
            echo "Init container completed successfully"
    containers:
      app:
        image:
          repository: ghcr.io/openclaw/openclaw
          tag: 2026.2.21@sha256:ce271192cd70250d16fc5911903d9953467a40faf8b34e87cbd042e6b49b6036
        command:
          - /bin/sh
          - -c
          - |
            # Set up openclawbot CLI symlink
            ln -sf /app/openclawbot.mjs /home/node/.local/bin/openclawbot
            # Start gateway
            exec node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured
        env:
          BROWSER_WS_ENDPOINT: "ws://localhost:9222"
          GOPATH: /home/node/go
          HOME: &homepath /home/node
          HOMEBREW_CELLAR: /home/node/.local/homebrew/Cellar
          HOMEBREW_PREFIX: /home/node/.local/homebrew
          HOMEBREW_REPOSITORY: /home/node/.local/homebrew
          PATH: /home/node/.local/bin:/home/node/.local/go/bin:/home/node/.local/homebrew/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          PIP_BREAK_SYSTEM_PACKAGES: "1"
          TERM: xterm-256color
        envFrom:
          - secretRef:
              name: openclaw-secret
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi
      chrome:
        image:
          repository: zenika/alpine-chrome
          tag: with-node
        command:
          - chromium-browser
          - --headless=new
          - --disable-gpu
          - --remote-debugging-address=0.0.0.0
          - --remote-debugging-port=9222
          - --no-sandbox
          - --disable-dev-shm-usage
          # Stealth flags to reduce bot detection
          - --disable-blink-features=AutomationControlled
          - --user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
      codeserver:
        image:
          repository: ghcr.io/coder/code-server
          tag: 4.109.2@sha256:1b84cd817fe8eb1159323ae9d2f29b3c70c6ccd44958d651a94900cf7f0ff9c4
        args:
          [
            "--auth",
            "none",
            "--user-data-dir",
            "/home/node/.vscode",
            "--extensions-dir",
            "/home/node/.vscode",
            "--port",
            "12321",
            "/home/node/.openclaw/workspace",
          ]
        resources:
          requests:
            cpu: 10m
          limits:
            memory: 1Gi

defaultPodOptions:
  shareProcessNamespace: true
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    fsGroupChangePolicy: OnRootMismatch
service:
  app:
    ports:
      http:
        port: &port 18789
      codeserver:
        port: &codeserverPort 12321
route:
  app:
    enabled: true
    kind: HTTPRoute
    parentRefs:
      - name: atoca-house-internal
        namespace: kube-system
    hostnames:
      - claw.atoca.house
    rules:
      - backendRefs:
          - name: openclaw
            port: *port
        matches:
          - path:
              type: PathPrefix
              value: /
  codeserver:
    enabled: true
    kind: HTTPRoute
    parentRefs:
      - name: atoca-house-internal
        namespace: kube-system
    hostnames:
      - claw-code.atoca.house
    rules:
      - backendRefs:
          - name: openclaw
            port: *codeserverPort
        matches:
          - path:
              type: PathPrefix
              value: /
rbac:
  roles:
    openclaw-read-all:
      type: ClusterRole
      rules:
        - apiGroups: [""]
          resources: [
              "pods",
              "nodes",
              "services",
              "namespaces",
              "configmaps",
              "persistentvolumes",
              "persistentvolumeclaims",
              "endpoints",
              "resourcequotas",
              "limitranges",
              "serviceaccounts",
              "events",
            ] # Added events
          verbs: ["get", "list", "watch"]
        - apiGroups: [""]
          resources: ["pods/log"]
          verbs: ["get", "list"]
        - apiGroups: ["apps"]
          resources:
            ["deployments", "daemonsets", "statefulsets", "replicasets"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["batch"]
          resources: ["jobs", "cronjobs"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["networking.k8s.io"]
          resources: ["ingresses", "networkpolicies"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["storage.k8s.io"]
          resources: ["storageclasses"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["rbac.authorization.k8s.io"]
          resources:
            ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["metrics.k8s.io"]
          resources: ["nodes", "pods"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["helm.toolkit.fluxcd.io"]
          resources: ["helmreleases"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["kustomize.toolkit.fluxcd.io"]
          resources: ["kustomizations"]
          verbs: ["get", "list", "watch"]
        - apiGroups: ["external-secrets.io"]
          resources: ["externalsecrets"]
          verbs: ["get", "list", "watch"]
    openclaw-write-restricted:
      type: Role
      rules:
        - apiGroups: [""]
          resources: ["pods"]
          verbs: ["delete"]
        - apiGroups: ["apps"]
          resources: ["deployments"]
          verbs: ["patch", "update"]
  bindings:
    openclaw-read-all:
      type: ClusterRoleBinding
      roleRef:
        identifier: openclaw-read-all
      subjects:
        - identifier: openclaw
          serviceAccount: openclaw
    openclaw-write-restricted:
      type: RoleBinding
      roleRef:
        identifier: openclaw-write-restricted
      subjects:
        - identifier: openclaw
          serviceAccount: openclaw
serviceAccount:
  openclaw: {}
persistence:
  config:
    enabled: true
    type: persistentVolumeClaim
    storageClass: ceph-block
    accessMode: ReadWriteOnce
    size: 5Gi
    globalMounts:
      - path: *homepath
  openclaw-config:
    type: secret
    name: "openclaw-config"
    globalMounts:
      - path: /home/node/.openclaw/openclaw.json
        subPath: openclaw.json
