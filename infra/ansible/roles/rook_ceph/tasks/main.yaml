---
# Verify Rook-Ceph storage is deployed and healthy

- name: Wait for Rook-Ceph operator application to be synced and healthy
  ansible.builtin.shell:
    cmd: >
      kubectl --kubeconfig={{ kubeconfig }}
      get application rook-ceph-operator -n {{ argocd_namespace }}
      -o jsonpath='{.status.health.status}' | grep -q Healthy &&
      kubectl --kubeconfig={{ kubeconfig }}
      get application rook-ceph-operator -n {{ argocd_namespace }}
      -o jsonpath='{.status.sync.status}' | grep -q Synced
  retries: "{{ default_retries }}"
  delay: "{{ default_delay }}"
  register: rook_operator_app_ready
  until: rook_operator_app_ready.rc == 0
  changed_when: false

- name: Wait for Rook-Ceph operator pods to be ready
  ansible.builtin.command:
    cmd: >
      kubectl wait --for=condition=ready pod
      -l app=rook-ceph-operator
      -n {{ rook_ceph_namespace }}
      --timeout=300s
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  retries: 5
  delay: "{{ default_delay }}"
  register: rook_operator_pods_ready
  until: rook_operator_pods_ready.rc == 0
  changed_when: false

- name: Wait for Rook-Ceph cluster application to be synced and healthy
  ansible.builtin.shell:
    cmd: >
      kubectl --kubeconfig={{ kubeconfig }}
      get application rook-ceph-cluster -n {{ argocd_namespace }}
      -o jsonpath='{.status.health.status}' | grep -q Healthy &&
      kubectl --kubeconfig={{ kubeconfig }}
      get application rook-ceph-cluster -n {{ argocd_namespace }}
      -o jsonpath='{.status.sync.status}' | grep -q Synced
  retries: 40
  delay: "{{ default_delay }}"
  register: rook_cluster_app_ready
  until: rook_cluster_app_ready.rc == 0
  changed_when: false

- name: Wait for Ceph cluster to be healthy
  ansible.builtin.shell:
    cmd: >
      kubectl --kubeconfig={{ kubeconfig }}
      -n {{ rook_ceph_namespace }}
      exec deploy/rook-ceph-tools -- ceph health
      | grep -q HEALTH_OK
  retries: 60
  delay: "{{ default_delay }}"
  register: ceph_healthy
  until: ceph_healthy.rc == 0
  changed_when: false
  failed_when: false
  when: enable_ceph_verification

- name: Get Ceph cluster status
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig={{ kubeconfig }}
      -n {{ rook_ceph_namespace }}
      exec -it deploy/rook-ceph-tools -- ceph status
  register: ceph_status
  changed_when: false
  when: enable_detailed_output and enable_ceph_verification

- name: Display Ceph status
  ansible.builtin.debug:
    msg: "{{ ceph_status.stdout_lines }}"
  when: enable_detailed_output and enable_ceph_verification and ceph_status is defined

- name: Get storage classes
  ansible.builtin.command:
    cmd: "kubectl --kubeconfig={{ kubeconfig }} get storageclass"
  register: storage_classes
  changed_when: false

- name: Display storage classes
  ansible.builtin.debug:
    msg: "{{ storage_classes.stdout_lines }}"
  when: enable_detailed_output

- name: Display Rook-Ceph verification complete
  ansible.builtin.debug:
    msg:
      - "Rook-Ceph verification complete!"
      - "Operator: Healthy and Synced"
      - "Cluster: Healthy and Synced"
      - "Ceph Status: {{ 'HEALTH_OK' if (ceph_healthy is defined and ceph_healthy.rc == 0) else 'Verifying...' }}"
