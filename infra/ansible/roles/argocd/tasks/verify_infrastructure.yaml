---
# Verify critical infrastructure applications are synced and healthy

- name: Wait for cert-manager to be synced and healthy
  ansible.builtin.shell:
    cmd: >
      kubectl --kubeconfig={{ kubeconfig }}
      get application cert-manager -n {{ argocd_namespace }}
      -o jsonpath='{.status.health.status}' | grep -q Healthy &&
      kubectl --kubeconfig={{ kubeconfig }}
      get application cert-manager -n {{ argocd_namespace }}
      -o jsonpath='{.status.sync.status}' | grep -q Synced
  retries: "{{ default_retries }}"
  delay: "{{ default_delay }}"
  register: cert_manager_ready
  until: cert_manager_ready.rc == 0
  changed_when: false

- name: Wait for external-secrets to be synced and healthy
  ansible.builtin.shell:
    cmd: >
      kubectl --kubeconfig={{ kubeconfig }}
      get application external-secrets -n {{ argocd_namespace }}
      -o jsonpath='{.status.health.status}' | grep -q Healthy &&
      kubectl --kubeconfig={{ kubeconfig }}
      get application external-secrets -n {{ argocd_namespace }}
      -o jsonpath='{.status.sync.status}' | grep -q Synced
  retries: "{{ default_retries }}"
  delay: "{{ default_delay }}"
  register: external_secrets_ready
  until: external_secrets_ready.rc == 0
  changed_when: false

- name: Wait for one-password operator to be synced and healthy
  ansible.builtin.shell:
    cmd: >
      kubectl --kubeconfig={{ kubeconfig }}
      get application one-password -n {{ argocd_namespace }}
      -o jsonpath='{.status.health.status}' | grep -q Healthy &&
      kubectl --kubeconfig={{ kubeconfig }}
      get application one-password -n {{ argocd_namespace }}
      -o jsonpath='{.status.sync.status}' | grep -q Synced
  retries: "{{ default_retries }}"
  delay: "{{ default_delay }}"
  register: onepassword_ready
  until: onepassword_ready.rc == 0
  changed_when: false

- name: Display infrastructure verification status
  ansible.builtin.debug:
    msg: "Critical infrastructure applications are synced and healthy"
