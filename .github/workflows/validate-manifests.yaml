name: Validate Manifests

on:
  pull_request:
    paths:
      - "**/*.yaml"
      - "**/*.yml"
      - "!stacks/**" # Exclude docker-compose
  push:
    branches: ["main"]
    paths:
      - "**/*.yaml"
      - "**/*.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-yaml:
    name: Validate YAML Syntax
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || 'arc-runners' }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.x'

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint --config-data '{extends: relaxed, rules: {line-length: {max: 120}}}' \
            infra/ apps/ argocd/ .github/ || true

  validate-kubernetes:
    name: Validate Kubernetes Manifests
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || 'arc-runners' }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          find infra/k8s apps -name '*.yaml' -type f ! -name 'values.yaml' ! -name 'secrets*.yaml' \
            -exec kubeconform -summary -output json {} + || true

  validate-argocd:
    name: Validate ArgoCD Applications
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || 'arc-runners' }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup ArgoCD CLI
        run: |
          curl -fsSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x /tmp/argocd
          sudo mv /tmp/argocd /usr/local/bin/

      - name: Validate ArgoCD Applications
        run: |
          # Find all application.yaml files
          find infra/k8s apps argocd/applications -name 'application.yaml' -type f | while read -r app; do
            echo "Validating: $app"
            argocd app validate --loglevel warn "$app" || echo "Warning: $app validation had issues"
          done

  comment-results:
    name: Comment Results
    runs-on: ${{ github.event_name == 'pull_request' && 'ubuntu-latest' || 'arc-runners' }}
    needs: [validate-yaml, validate-kubernetes, validate-argocd]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Comment PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const body = `## âœ… Manifest Validation Complete

            All YAML manifests have been validated:
            - YAML syntax validation
            - Kubernetes manifest validation (Kubeconform)
            - ArgoCD application validation

            *Validation run: ${context.runNumber}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
