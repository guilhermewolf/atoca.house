---
# Seal secrets using kubeseal

- name: Seal onepassword-token secret
  ansible.builtin.command:
    cmd: >
      kubeseal
      --controller-namespace={{ sealed_secrets_namespace }}
      -f /tmp/onepassword-token-unsealed.yaml
      -w {{ k8s_infra_dir }}/security/one-password/onepassword-token.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: seal_token
  changed_when: seal_token.rc == 0

- name: Seal op-credentials secret
  ansible.builtin.command:
    cmd: >
      kubeseal
      --controller-namespace={{ sealed_secrets_namespace }}
      -f /tmp/op-credentials-unsealed.yaml
      -w {{ k8s_infra_dir }}/security/one-password/op-credentials.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: seal_credentials
  changed_when: seal_credentials.rc == 0

- name: Display sealed secrets location
  ansible.builtin.debug:
    msg:
      - "Sealed secrets created:"
      - "  - {{ k8s_infra_dir }}/security/one-password/onepassword-token.yaml"
      - "  - {{ k8s_infra_dir }}/security/one-password/op-credentials.yaml"
      - ""
      - "Next steps:"
      - "  1. Review the sealed secrets"
      - "  2. Commit to Git: git add {{ k8s_infra_dir }}/security/one-password/*.yaml"
      - "  3. Commit: git commit -m 'Update 1Password sealed secrets'"
      - "  4. Push: git push"
