---
# Create Kubernetes secrets (unsealed)

- name: Create Kubernetes secret for onepassword-token
  ansible.builtin.command:
    cmd: >
      kubectl -n {{ onepassword_namespace }}
      create secret generic onepassword-token
      --dry-run=client
      --from-file=token=/tmp/op_token.txt
      -o yaml
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: onepassword_token_secret
  changed_when: false

- name: Write onepassword-token secret to file
  ansible.builtin.copy:
    content: "{{ onepassword_token_secret.stdout }}"
    dest: /tmp/onepassword-token-unsealed.yaml
    mode: '0600'

- name: Create Kubernetes secret for op-credentials
  ansible.builtin.command:
    cmd: >
      kubectl -n {{ onepassword_namespace }}
      create secret generic op-credentials
      --dry-run=client
      --from-file=1password-credentials.json=/tmp/1password-credentials.json
      -o yaml
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: op_credentials_secret
  changed_when: false

- name: Write op-credentials secret to file
  ansible.builtin.copy:
    content: "{{ op_credentials_secret.stdout }}"
    dest: /tmp/op-credentials-unsealed.yaml
    mode: '0600'
