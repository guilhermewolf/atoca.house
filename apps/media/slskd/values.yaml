controllers:
  slskd:
    type: statefulset
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      slskd:
        image:
          repository: ghcr.io/slskd/slskd
          tag: 0.24.3@sha256:bcf9820dab68e21d2bba8ebb1ffd583d71fcba542a50a1e998119f69b7b498fe
        env:
          DOTNET_BUNDLE_EXTRACT_BASE_DIR: /tmp/.net
          TZ: Europe/Amsterdam
          SLSKD_APP_DIR: /config
          SLSKD_HTTP_PORT: &port 80
          SLSKD_NO_AUTH: true
          SLSKD_NO_HTTPS: true
          SLSKD_NO_VERSION_CHECK: true
          SLSKD_SLSK_LISTEN_PORT: 50429
        envFrom:
          - secretRef:
              name: "slskd-secret"
        probes:
          liveness: &probes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: *port
              initialDelaySeconds: 0
              periodSeconds: 10
              timeoutSeconds: 1
              failureThreshold: 3
          readiness: *probes
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities: {drop: ["ALL"]}
        resources:
          requests:
            cpu: 10m
            memory: 128Mi
          limits:
            memory: 1Gi
    statefulset:
      volumeClaimTemplates:
        - name: config
          storageClass: ceph-block
          accessMode: ReadWriteOnce
          size: 5Gi
defaultPodOptions:
  annotations:
    k8s.v1.cni.cncf.io/networks: |-
      [{
        "name": "vpn",
        "namespace": "kube-system",
        "ips": ["192.168.90.12/24"],
        "mac": "c6:58:f2:a7:62:ce"
      }]
  securityContext:
    runAsNonRoot: true
    runAsUser: 99
    runAsGroup: 100
    fsGroup: 100
    fsGroupChangePolicy: OnRootMismatch

service:
  slskd:
    controller: slskd
    ports:
      http:
        port: *port
route:
  slskd:
    enabled: true
    kind: HTTPRoute
    parentRefs:
      - name: atoca-house-internal
        namespace: kube-system
    hostnames:
      - slskd.atoca.house
    rules:
      - backendRefs:
          - name: slskd
            port: 80
        matches:
          - path:
              type: PathPrefix
              value: /

configMaps:
  config:
    data:
      slskd.yml: |-
        directories:
          incomplete: /downloads/incomplete
          downloads: /downloads/complete
        permissions:
          file:
            mode: 750
        shares:
          directories:
            - /playlists
          filters:
            - \.ini$
            - Thumbs.db$
            - \.DS_Store$
persistence:
  config-file:
    type: configMap
    identifier: config
    globalMounts:
      - path: /config/slskd.yml
        subPath: slskd.yml
  media:
    type: nfs
    server: nas.internal
    path: /mnt/user/data/slskd
    globalMounts:
      - path: /downloads/

  playlists:
    type: nfs
    server: nas.internal
    path: /mnt/user/musics/playlists
    globalMounts:
      - path: /playlists
  tmp:
    type: emptyDir
