---
# Common configuration for all control plane nodes
# This patch is applied to all 3 control plane nodes during generation

machine:
  # Install configuration
  install:
    disk: /dev/sda  # 256GB system disk
    wipe: false

  # Network configuration
  network:
    nameservers:
      - 192.168.178.1
      - 1.1.1.1
      - 1.0.0.1

  # Kubelet configuration for Rook-Ceph
  kubelet:
    extraMounts:
      - destination: /var/lib/rook
        type: bind
        source: /var/lib/rook
        options:
          - bind
          - rshared
          - rw
    nodeIP:
      validSubnets:
        - 192.168.178.0/24
    extraArgs:
      feature-gates: GracefulNodeShutdown=true,NewVolumeManagerReconstruction=false
      rotate-server-certificates: "true"

  # Time configuration
  time:
    disabled: false
    servers:
      - time.cloudflare.com
      - time.google.com

  # Features
  features:
    rbac: true
    stableHostname: true
    kubernetesTalosAPIAccess:
      enabled: true
      allowedRoles:
        - os:admin
      allowedKubernetesNamespaces:
        - kube-system

  # System disk partitions - Mount 1TB data disk for Ceph
  disks:
    - device: /dev/sdb  # 1TB data disk for Ceph
      partitions:
        - mountpoint: /var/mnt/ceph

  # Sysctls for networking
  sysctls:
    fs.inotify.max_user_watches: "1048576"
    fs.inotify.max_user_instances: "8192"
    net.core.rmem_max: "2500000"
    net.core.wmem_max: "2500000"

# Cluster configuration
cluster:
  # Discovery
  discovery:
    enabled: true
    registries:
      kubernetes:
        disabled: false
      service:
        disabled: false

  # Network
  network:
    cni:
      name: none  # Using Cilium
    dnsDomain: cluster.local
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/12

  # Proxy configuration
  proxy:
    disabled: true  # Using Cilium kube-proxy replacement

  # Scheduler configuration
  scheduler:
    config:
      apiVersion: kubescheduler.config.k8s.io/v1
      kind: KubeSchedulerConfiguration

  # Controller manager
  controllerManager:
    extraArgs:
      bind-address: 0.0.0.0

  # API server configuration
  apiServer:
    certSANs:
      - 192.168.178.201
      - 192.168.178.202
      - 192.168.178.203
    extraArgs:
      feature-gates: MixedProtocolLBService=true,ServerSideApply=true

  # Etcd configuration (3-node HA)
  etcd:
    advertisedSubnets:
      - 192.168.178.0/24

  # Allow scheduling on control plane nodes (no workers)
  allowSchedulingOnControlPlanes: true

  # Inline manifests for critical components that need to run before CNI
  inlineManifests: []
