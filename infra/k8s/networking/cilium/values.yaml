# Cilium configuration for Talos Linux on Raspberry Pi 4
# This configuration enables kube-proxy replacement and L2 announcements

# Kube-proxy replacement configuration
kubeProxyReplacement: true
k8sServiceHost: 127.0.0.1  # KubePrism endpoint
k8sServicePort: 7445       # KubePrism port

# IPAM configuration - use Kubernetes mode
ipam:
  mode: kubernetes

# Operator configuration
operator:
  dashboards:
    enabled: true
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
  replicas: 2
  rollOutPods: true

# Enable Hubble for observability
hubble:
  enabled: false

# L2 Announcements for LoadBalancer support (replaces MetalLB)
l2announcements:
  enabled: true

# External IPs configuration
externalIPs:
  enabled: true

# LoadBalancer IP pool configuration
loadBalancer:
  algorithm: maglev
  mode: dsr
  serviceTopology: true
# This will be configured via LB IPAM CRDs below
bgpControlPlane:
  enabled: false  # Not using BGP, using L2 instead
localRedirectPolicies:
  enabled: true


# Security context for Talos Linux
securityContext:
  capabilities:
    ciliumAgent:
      - CHOWN
      - KILL
      - NET_ADMIN
      - NET_RAW
      - IPC_LOCK
      - SYS_ADMIN
      - SYS_RESOURCE
      - PERFMON
      - BPF
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cleanCiliumState:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_RESOURCE

socketLB:
  enabled: true
  hostNamespaceOnly: true
# Talos-specific configuration
cgroup:
  autoMount:
    enabled: false  # Talos manages cgroup mounts
  hostRoot: /sys/fs/cgroup

# Container runtime configuration
# containerRuntime:
#   integration: containerd

# Encryption (optional - can be enabled later)
encryption:
  enabled: false
  type: wireguard

# Monitoring
# prometheus:
#   enabled: true
#   serviceMonitor:
#     enabled: true

# Enable IPv4 (IPv6 can be added later if needed)
ipv4:
  enabled: true
ipv6:
  enabled: false

# Tunnel protocol
tunnelProtocol: vxlan

# Enable host firewall
hostFirewall:
  enabled: false  # Talos handles host firewall

autoDirectNodeRoutes: true

rollOutCiliumPods: true
routingMode: native
ipv4NativeRoutingCIDR: 10.244.0.0/16
dashboards:
  enabled: true

# Enable bandwidth manager for better performance
bandwidthManager:
  enabled: true
  bbr: true

# Enable local redirect policy
localRedirectPolicy: true

# Disable CNI chaining (Cilium is the primary CNI)
cni:
  exclusive: true
  chainingMode: none

# Enable endpoint routes for better performance
endpointRoutes:
  enabled: true

bpf:
  datapathMode: netkit
  masquerade: true
  preallocateMaps: true
  tproxy: true
bpfClockProbe: true
bgpControlPlane:
  enabled: true

enableIPv4Masquerade: true
