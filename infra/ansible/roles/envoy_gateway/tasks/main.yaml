---
# Install and verify Envoy Gateway

- name: Add Envoy Gateway Helm repository
  ansible.builtin.command:
    cmd: helm repo add envoyproxy https://gateway.envoyproxy.io
  register: helm_repo_add
  changed_when: "'has been added' in helm_repo_add.stdout"
  failed_when: false

- name: Update Helm repositories
  ansible.builtin.command:
    cmd: helm repo update
  changed_when: false

# renovate: datasource=helm depName=gateway-helm registryUrl=oci://docker.io/envoyproxy
- name: Install Envoy Gateway via Helm
  ansible.builtin.command:
    cmd: >
      helm upgrade --install envoy-gateway oci://docker.io/envoyproxy/gateway-helm
      --version v1.6.1
      --namespace envoy-gateway-system
      --create-namespace
      --values {{ k8s_infra_dir }}/networking/envoy-gateway/values.yaml
      --wait
      --timeout 10m
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: envoy_gateway_install
  changed_when: "'has been upgraded' in envoy_gateway_install.stdout or 'has been installed' in envoy_gateway_install.stdout"

- name: Wait for Envoy Gateway deployment to be available
  ansible.builtin.command:
    cmd: >
      kubectl wait --for=condition=available
      deployment/envoy-gateway
      -n envoy-gateway-system
      --timeout=300s
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  retries: 3
  delay: "{{ default_delay }}"
  register: envoy_gateway_ready
  until: envoy_gateway_ready.rc == 0
  changed_when: false

- name: Wait for Envoy Gateway pods to be ready
  ansible.builtin.command:
    cmd: >
      kubectl wait --for=condition=ready pod
      -l control-plane=envoy-gateway
      -n envoy-gateway-system
      --timeout=300s
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  retries: 3
  delay: "{{ default_delay }}"
  register: envoy_gateway_pods_ready
  until: envoy_gateway_pods_ready.rc == 0
  changed_when: false

- name: Verify Gateway API CRDs are installed
  ansible.builtin.command:
    cmd: kubectl get crd gateways.gateway.networking.k8s.io
  environment:
    KUBECONFIG: "{{ kubeconfig }}"
  register: gateway_api_crd_check
  changed_when: false

- name: Get Envoy Gateway status
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig={{ kubeconfig }}
      get deployment,pods -n envoy-gateway-system
  register: envoy_gateway_status
  changed_when: false

- name: Display Envoy Gateway status
  ansible.builtin.debug:
    msg: "{{ envoy_gateway_status.stdout_lines }}"
  when: enable_detailed_output
